name: Auto Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - 'aws/build.gradle'
      - 'azure/build.gradle'
      - 'files/build.gradle'
  workflow_dispatch:
    inputs:
      provider:
        description: 'Provider to release'
        type: choice
        required: true
        options:
          - aws
          - azure
          - files
          - all

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Create release tags
        run: |
          MANUAL_PROVIDER="${{ inputs.provider }}"

          if [ -n "$MANUAL_PROVIDER" ] && [ "$MANUAL_PROVIDER" != "all" ]; then
            PROVIDERS="$MANUAL_PROVIDER"
          else
            PROVIDERS="aws azure files"
          fi

          for PROVIDER in $PROVIDERS; do
            BUILD_FILE="$PROVIDER/build.gradle"

            if [ ! -f "$BUILD_FILE" ]; then
              echo "Skipping $PROVIDER: $BUILD_FILE not found"
              continue
            fi

            # For push events, check if file was modified
            if [ -z "$MANUAL_PROVIDER" ]; then
              if ! git diff --name-only HEAD~1 HEAD | grep -q "^$BUILD_FILE$"; then
                continue
              fi
            fi

            CURRENT_VERSION=$(grep "^version = " "$BUILD_FILE" | sed "s/version = ['\"]//;s/['\"]//")

            if [ -z "$CURRENT_VERSION" ]; then
              echo "Could not extract version from $BUILD_FILE"
              continue
            fi

            TAG="${PROVIDER}-v${CURRENT_VERSION}"

            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "Tag $TAG already exists, skipping"
              continue
            fi

            echo "Creating tag: $TAG"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "$TAG"
            git push origin "$TAG"

            echo "Created and pushed tag: $TAG"
          done
