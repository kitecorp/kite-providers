name: Auto Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - 'aws/build.gradle'
      - 'azure/build.gradle'
      - 'files/build.gradle'

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Detect version changes and create tags
        run: |
          # Get list of providers
          PROVIDERS="aws azure files"

          for PROVIDER in $PROVIDERS; do
            BUILD_FILE="$PROVIDER/build.gradle"

            # Skip if file doesn't exist
            if [ ! -f "$BUILD_FILE" ]; then
              continue
            fi

            # Check if this file was modified
            if ! git diff --name-only HEAD~1 HEAD | grep -q "^$BUILD_FILE$"; then
              continue
            fi

            # Extract current version
            CURRENT_VERSION=$(grep "^version = " "$BUILD_FILE" | sed "s/version = ['\"]//;s/['\"]//")

            if [ -z "$CURRENT_VERSION" ]; then
              echo "Could not extract version from $BUILD_FILE"
              continue
            fi

            TAG="${PROVIDER}-v${CURRENT_VERSION}"

            # Check if tag already exists
            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "Tag $TAG already exists, skipping"
              continue
            fi

            echo "Creating tag: $TAG"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "$TAG"
            git push origin "$TAG"

            echo "Created and pushed tag: $TAG"
          done
