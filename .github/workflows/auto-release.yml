name: Auto Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - 'aws/build.gradle'
      - 'azure/build.gradle'
      - 'files/build.gradle'
  workflow_dispatch:
    inputs:
      provider:
        description: 'Provider to release'
        type: choice
        required: true
        options:
          - aws
          - azure
          - files
          - all

jobs:
  detect:
    runs-on: self-hosted
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect providers to release
        id: set-matrix
        run: |
          MANUAL_PROVIDER="${{ inputs.provider }}"
          PROVIDERS_TO_RELEASE=""

          if [ -n "$MANUAL_PROVIDER" ] && [ "$MANUAL_PROVIDER" != "all" ]; then
            PROVIDERS="$MANUAL_PROVIDER"
          else
            PROVIDERS="aws azure files"
          fi

          for PROVIDER in $PROVIDERS; do
            BUILD_FILE="$PROVIDER/build.gradle"

            if [ ! -f "$BUILD_FILE" ]; then
              continue
            fi

            VERSION=$(grep "^version = " "$BUILD_FILE" | sed "s/version = ['\"]//;s/['\"]//")
            if [ -z "$VERSION" ]; then
              continue
            fi

            TAG="$PROVIDER-v$VERSION"

            # For push events, check if release already exists for this version
            if [ -z "$MANUAL_PROVIDER" ]; then
              # Check if tag already has a release (not just a tag)
              if gh release view "$TAG" &>/dev/null; then
                echo "Release $TAG already exists, skipping $PROVIDER"
                continue
              fi
            fi

            if [ -n "$PROVIDERS_TO_RELEASE" ]; then
              PROVIDERS_TO_RELEASE="$PROVIDERS_TO_RELEASE,"
            fi
            PROVIDERS_TO_RELEASE="$PROVIDERS_TO_RELEASE{\"provider\":\"$PROVIDER\",\"version\":\"$VERSION\"}"
          done

          if [ -z "$PROVIDERS_TO_RELEASE" ]; then
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"include\":[$PROVIDERS_TO_RELEASE]}" >> $GITHUB_OUTPUT
          fi

          echo "Providers to release: $PROVIDERS_TO_RELEASE"

  release:
    needs: detect
    if: ${{ fromJson(needs.detect.outputs.matrix).include[0] != null }}
    runs-on: self-hosted
    permissions:
      contents: write
    strategy:
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Checkout kite-api
        uses: actions/checkout@v4
        with:
          repository: kitecorp/kite-api
          path: sdk-build/kite-api

      - name: Checkout kite-proto
        uses: actions/checkout@v4
        with:
          repository: kitecorp/kite-proto
          path: sdk-build/kite-proto

      - name: Checkout kite-provider-sdk
        uses: actions/checkout@v4
        with:
          repository: kitecorp/kite-provider-sdk
          path: sdk-build/kite-provider-sdk

      - name: Create multi-project settings
        run: |
          cat > sdk-build/settings.gradle << 'EOF'
          plugins {
              id 'org.gradle.toolchains.foojay-resolver-convention' version '1.0.0'
          }
          rootProject.name = 'kite-sdk-build'
          include 'kite-api'
          include 'kite-proto'
          include 'kite-provider-sdk'
          EOF

          cat > sdk-build/build.gradle << 'EOF'
          // Root build file - subprojects have their own build.gradle
          EOF

      - name: Setup Gradle wrapper for SDK build
        working-directory: sdk-build
        run: gradle wrapper --gradle-version 8.13

      - name: Build and publish SDK to Maven Local
        working-directory: sdk-build
        run: ./gradlew :kite-api:publishToMavenLocal :kite-proto:publishToMavenLocal :kite-provider-sdk:publishToMavenLocal --no-daemon

      - name: Build provider
        working-directory: ${{ matrix.provider }}
        run: |
          chmod +x gradlew
          ./gradlew installDist --no-daemon

      - name: Create distribution zip
        working-directory: ${{ matrix.provider }}
        run: |
          INSTALL_DIR=$(find build/install -mindepth 1 -maxdepth 1 -type d | head -1)
          cd "$INSTALL_DIR"
          zip -r $GITHUB_WORKSPACE/${{ matrix.provider }}.zip .

      - name: Create tag and release
        run: |
          TAG="${{ matrix.provider }}-v${{ matrix.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Delete existing tag if present
          git push origin ":refs/tags/$TAG" 2>/dev/null || true

          # Create and push tag
          git tag -f "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ matrix.provider }} v${{ matrix.version }}
          tag_name: ${{ matrix.provider }}-v${{ matrix.version }}
          files: ${{ matrix.provider }}.zip
          generate_release_notes: true
